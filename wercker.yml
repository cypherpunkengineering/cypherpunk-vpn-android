box: cypherpunk/android
build:
  steps:
    - install-packages:
        packages: openssh-client git unzip make file
    - add-ssh-key:
        keyname: cypherpunkbuilder
        host: github.com
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
    - script:
        name: run build script
        code: |
            ./build-ubuntu
  after-steps:
    - install-packages:
        packages: curl
    - slack-notifier:
        url: $SLACK_URL
        channel: dev-notifications
        username: wercker
deploy:
    steps:
        - install-packages:
            packages: curl openssh-client
        - script:
            name: Upload apk to DeployGate
            code: |
              curl -F file=@app/build/outputs/apk/app-debug.apk -F token="$DEPLOYGATE_API_KEY" https://deploygate.com/api/users/cypherpunk/apps
        - add-ssh-key:
            keyname: cypherpunkbuilder
        - script:
            name: Archive apk to build repo server
            code: |
              mkdir -p $HOME/.ssh/
              echo '[builds-upload.cypherpunk.engineering]:92,[208.111.52.44]:92 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBF3loDObhGOkV6ocni0AAv9il/yeQOuhzExcB9NHJRqGavyHhOi5NdZBEeNdXYYEou9vYilARYESVnknRJsK6nA=' > $HOME/.ssh/known_hosts
              BUILD_NUMBER=`date +%s`
              scp -P92 "app/build/outputs/apk/app-debug.apk" "upload@builds-upload.cypherpunk.engineering:/data/builds/`printf 'cypherpunk-vpn-android-%05d' ${BUILD_NUMBER}`.apk"
