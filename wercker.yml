box: cypherpunk/android
build:
  steps:
    - install-packages:
        packages: openssh-client git unzip make file
    - add-ssh-key:
        keyname: cypherpunkbuilder
        host: github.com
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
    - script:
        name: initialize git submodules
        code: |
            git submodule update --init
    - script:
        name: install android ndk
        code: |
            export ANDROID_NDK_VERSION=r12b
            wget -q https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux-x86_64.zip
            unzip android-ndk-${ANDROID_NDK_VERSION}-linux-x86_64.zip
            export ANDROID_NDK_HOME="${PWD}/android-ndk-${ANDROID_NDK_VERSION}"
            export PATH=$PATH:${ANDROID_NDK_HOME}
    - script:
        name: build native libraries
        code: |
            cd openvpn/main/
            ./misc/build-native.sh
            cd ../../
    - script:
        name: build android app
        code: |
            ./gradlew -PdisablePreDex --project-cache-dir=$WERCKER_CACHE_DIR build
    - script:
        name: cleanup
        code: |
            rm -rf .git
            rm -rf ${ANDROID_NDK_HOME}
            rm -rf openvpn
  after-steps:
    - install-packages:
        packages: curl
    - slack-notifier:
        url: $SLACK_URL
        channel: dev-notifications
        username: wercker
deploy:
    steps:
        - install-packages:
            packages: curl openssh-client
        - script:
            name: Upload apk to DeployGate
            code: |
              curl -F file=@app/build/outputs/apk/app-debug.apk -F token="$DEPLOYGATE_API_KEY" https://deploygate.com/api/users/cypherpunk/apps
        - add-ssh-key:
            keyname: cypherpunkbuilder
            host: builds-upload.cypherpunk.com
        - script:
            name: Archive apk to build repo server
            code: |
              BUILD_NUMBER=`date +%s`
              scp -P92 "app/build/outputs/apk/app-debug.apk" "upload@builds-upload.cypherpunk.engineering:/data/builds/`printf 'cypherpunk-vpn-android-%05d' ${BUILD_NUMBER}`.apk"
